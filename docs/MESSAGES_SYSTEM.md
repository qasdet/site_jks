# Система личных сообщений

## Обзор

Система личных сообщений позволяет пользователям обмениваться приватными сообщениями с динамическими уведомлениями в реальном времени. Включает в себя:

- Отправку и получение личных сообщений
- **Динамические уведомления о новых сообщениях без обновления страницы**
- **Звуковые уведомления**
- **Детальные уведомления с превью сообщения**
- API для получения количества непрочитанных сообщений
- Автоматическое обновление статуса "прочитано"
- **Пульсирующие бейджи в навигации**
- **Просмотр истории сообщений**
- **Уведомления о новых сообщениях**
- **Административную панель для управления сообщениями**

## Модели данных

### PrivateMessage

```python
class PrivateMessage(db.Model):
    __tablename__ = 'private_message'
    id = db.Column(db.Integer, primary_key=True)
    sender_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    recipient_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    content = db.Column(db.Text, nullable=False)
    sent_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_read = db.Column(db.Boolean, default=False)
```

## Маршруты

### Основные маршруты

- `GET /messages/` - Входящие и отправленные сообщения
- `GET /messages/send/<user_id>` - Форма отправки сообщения
- `POST /messages/send/<user_id>` - Отправка сообщения
- `GET /messages/view/<msg_id>` - Просмотр сообщения

### API маршруты

- `GET /messages/api/unread-count` - Количество непрочитанных сообщений
- `GET /messages/api/latest-messages` - Последние непрочитанные сообщения
- `POST /messages/api/mark-read/<msg_id>` - Отметить сообщение как прочитанное
- `GET /messages/api/status` - Общий статус сообщений пользователя

### Админ маршруты

- `GET /admin/private-messages` - Просмотр всех сообщений
- `POST /admin/private-messages/<int:message_id>/delete` - Удаление сообщения
- `POST /admin/private-messages/mass-action` - Массовые действия

## JavaScript функционал

### MessagesNotifications

Класс для управления уведомлениями о новых сообщениях:

```javascript
class MessagesNotifications {
    constructor() {
        this.checkInterval = 8000; // Проверка каждые 8 секунд
        this.lastCount = 0;
        this.lastMessageId = 0;
        this.notificationContainer = null;
        this.notificationSound = null;
        this.isInitialized = false;
        this.init();
    }
    
    // Методы:
    // - checkNewMessages() - Проверка новых сообщений
    // - showNewMessageNotification() - Показ уведомления с превью
    // - updateMessagesBadge() - Обновление пульсирующего бейджа
    // - playNotificationSound() - Воспроизведение звука
    // - forceCheck() - Принудительная проверка
}
```

### Функции уведомлений

1. **Периодическая проверка** - Каждые 8 секунд проверяет новые сообщения
2. **Детальные уведомления** - Показывает отправителя и превью сообщения
3. **Звуковые уведомления** - Короткий звуковой сигнал при новом сообщении
4. **Пульсирующий бейдж** - Анимированный бейдж в навигации
5. **Интерактивные уведомления** - Клик для перехода к сообщениям
6. **Автоматическое скрытие** - Уведомления исчезают через 8 секунд
7. **Эффекты при наведении** - Анимации при взаимодействии

### Тестирование уведомлений

В консоли браузера доступны функции для тестирования:

```javascript
// Показать тестовое уведомление
testMessageNotification()

// Принудительная проверка новых сообщений
messagesNotifications.forceCheck()

// Проиграть звук уведомления
messagesNotifications.playNotificationSound()

// Показать кастомное уведомление
messagesNotifications.showNewMessageNotification(1, [{
    id: 999,
    sender: 'Тестовый пользователь',
    content: 'Тестовое сообщение',
    sent_at: new Date().toLocaleString()
}])
```

## Интеграция

### Навигация

Ссылка "Сообщения" добавлена в навигацию всех основных страниц:
- Главная страница
- Блог
- Голосования  
- Форум

### Профиль пользователя

Кнопка "Написать сообщение" появляется на странице постов пользователя, если:
- Пользователь авторизован
- Просматривается не свой профиль

## Установка и настройка

1. **Создание таблиц:**
   ```bash
   python scripts/add_private_message_table.py
   ```

2. **Тестирование базового функционала:**
   ```bash
   python test_messages.py
   ```

3. **Тестирование уведомлений:**
   ```bash
   python test_notifications.py
   ```

4. **Запуск приложения:**
   ```bash
   python app.py
   ```

## Использование

### Отправка сообщения

1. Перейдите на страницу постов пользователя
2. Нажмите "Написать сообщение"
3. Введите текст сообщения
4. Нажмите "Отправить"

### Просмотр сообщений

1. Перейдите в раздел "Сообщения" в навигации
2. Просматривайте входящие и отправленные сообщения
3. Нажмите "Просмотреть" для чтения сообщения
4. Используйте "Ответить" для быстрого ответа

### Уведомления

- **Автоматические уведомления** появляются при получении новых сообщений
- **Детальная информация** - отправитель и превью сообщения
- **Звуковой сигнал** привлекает внимание
- **Клик по уведомлению** переводит к списку сообщений
- **Пульсирующий бейдж** в навигации показывает количество непрочитанных
- **Автоматическое скрытие** через 8 секунд

## API Endpoints

### GET /messages/api/unread-count
Возвращает количество непрочитанных сообщений:
```json
{
    "success": true,
    "count": 5,
    "timestamp": "2024-01-01T12:00:00"
}
```

### GET /messages/api/latest-messages
Возвращает последние непрочитанные сообщения:
```json
{
    "success": true,
    "messages": [
        {
            "id": 1,
            "sender": "username",
            "sender_id": 1,
            "content": "Текст сообщения...",
            "sent_at": "01.01.2024 12:00",
            "is_read": false
        }
    ],
    "total_unread": 1,
    "timestamp": "2024-01-01T12:00:00"
}
```

### POST /messages/api/mark-read/<msg_id>
Отмечает сообщение как прочитанное:
```json
{
    "success": true,
    "message": "Сообщение отмечено как прочитанное"
}
```

### GET /messages/api/status
Возвращает общий статус сообщений:
```json
{
    "success": true,
    "status": {
        "total_received": 10,
        "total_sent": 5,
        "unread_count": 3,
        "last_check": "2024-01-01T12:00:00"
    }
}
```

## Безопасность

- Доступ к сообщениям только для авторизованных пользователей
- Пользователи могут просматривать только свои сообщения
- Проверка прав доступа при просмотре сообщений
- API защищены декоратором `@login_required`

## Производительность

- **Оптимизированные запросы** - минимальная нагрузка на сервер
- **Кэширование состояния** - избежание лишних запросов
- **Graceful degradation** - система работает даже при ошибках
- **Обработка ошибок** - подробное логирование проблем

## Расширение

Возможные улучшения:
- **WebSocket уведомления** для мгновенной доставки
- **Push-уведомления** в браузере
- **Групповые сообщения**
- **Вложения файлов**
- **Поиск по сообщениям**
- **Удаление сообщений**
- **Блокировка пользователей**
- **Настройки уведомлений** (включить/выключить звук, интервал проверки)

## Админ панель

### Дашборд

На главной странице админ панели отображается:

- **Статистика сообщений**
  - Общее количество личных сообщений
  - Количество непрочитанных сообщений
  - Количество новых сообщений за неделю

- **Последние сообщения**
  - Превью последних 5 сообщений
  - Отображение отправителя и получателя
  - Статус прочтения

### Страница управления сообщениями

#### Фильтры и поиск
- Поиск по содержанию сообщения
- Фильтр по отправителю
- Сортировка по дате, отправителю, получателю
- Порядок сортировки (по возрастанию/убыванию)

#### Статистика
- Общее количество сообщений
- Количество прочитанных сообщений
- Количество непрочитанных сообщений
- Количество уникальных отправителей

#### Действия
- Просмотр полного текста сообщения (модальное окно)
- Удаление отдельных сообщений
- Массовое удаление выбранных сообщений
- Экспорт данных (планируется)

#### Интерфейс
- Адаптивная таблица с пагинацией
- Чекбоксы для массового выбора
- Кнопки действий с подтверждением
- Модальные окна для просмотра текста

## Установка и настройка

### 1. Миграция базы данных

```bash
python add_private_messages_table.py
```

### 2. Регистрация blueprint

В `app.py` добавьте:

```python
from messages import messages_bp
app.register_blueprint(messages_bp, url_prefix='/messages')
```

### 3. Подключение уведомлений

В базовых шаблонах добавьте:

```html
<script src="{{ url_for('static', filename='js/messages_notifications.js') }}"></script>
<script>
    new MessagesNotifications();
</script>
```

## Тестирование

### Тест уведомлений

```bash
python test_notifications.py
```

### Тест админ панели

```bash
python test_admin_messages.py
```

### Ручное тестирование

1. Создайте несколько пользователей
2. Отправьте сообщения между ними
3. Проверьте уведомления в реальном времени
4. Проверьте админ панель под администратором

## Безопасность

### Проверки доступа

- Пользователи могут просматривать только свои сообщения
- Администраторы имеют доступ ко всем сообщениям
- Проверка существования получателя при отправке
- Защита от XSS в содержании сообщений

### Ограничения

- Максимальная длина сообщения: 1000 символов
- Ограничение на частоту отправки (планируется)
- Логирование действий администраторов

## Планы развития

### Краткосрочные
- [ ] Экспорт сообщений в CSV/JSON
- [ ] Поиск по получателю в админ панели
- [ ] Фильтр по дате отправки
- [ ] Уведомления по email

### Долгосрочные
- [ ] Групповые сообщения
- [ ] Вложения файлов
- [ ] Шаблоны сообщений
- [ ] Автоматические ответы
- [ ] Архивирование старых сообщений

## Устранение неполадок

### Частые проблемы

1. **Уведомления не работают**
   - Проверьте консоль браузера на ошибки JavaScript
   - Убедитесь, что файл `messages_notifications.js` загружен
   - Проверьте доступность API endpoints

2. **Сообщения не отображаются в админ панели**
   - Проверьте права доступа пользователя (должен быть admin)
   - Убедитесь, что таблица `private_messages` существует
   - Проверьте логи Flask приложения

3. **Ошибки в базе данных**
   - Выполните миграцию: `python add_private_messages_table.py`
   - Проверьте целостность foreign keys
   - Убедитесь, что пользователи существуют

### Логи

Для отладки включите логирование в `app.py`:

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Поддержка

При возникновении проблем:

1. Проверьте логи приложения
2. Убедитесь в корректности миграций
3. Проверьте права доступа пользователей
4. Обратитесь к документации API 